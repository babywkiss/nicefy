(function(){"use strict";const H=Array.isArray,S=t=>typeof t=="string";var M=Math.pow;function O(t){let e=0,n=0,o=0;return t.length===4?(e=`0x${t[1]}${t[1]}`,n=`0x${t[2]}${t[2]}`,o=`0x${t[3]}${t[3]}`):t.length===7&&(e=`0x${t[1]}${t[2]}`,n=`0x${t[3]}${t[4]}`,o=`0x${t[5]}${t[6]}`),[parseInt(e),parseInt(n),parseInt(o)]}function C(t){let e=t[0]/255,n=t[1]/255,o=t[2]/255,s,r,f;return e=e>.04045?M((e+.055)/1.055,2.4):e/12.92,n=n>.04045?M((n+.055)/1.055,2.4):n/12.92,o=o>.04045?M((o+.055)/1.055,2.4):o/12.92,s=(e*.4124+n*.3576+o*.1805)/.95047,r=(e*.2126+n*.7152+o*.0722)/1,f=(e*.0193+n*.1192+o*.9505)/1.08883,s=s>.008856?M(s,1/3):7.787*s+16/116,r=r>.008856?M(r,1/3):7.787*r+16/116,f=f>.008856?M(f,1/3):7.787*f+16/116,[116*r-16,500*(s-r),200*(r-f)]}function B([t,e,n]){return`hsl(${t},${e},${n})`}const v=t=>{const e=t.match(/\d+/g);return e||[0,0,0]},T={rgb:v,hex:O,hsl:t=>{let[e,n,o]=v(t);n/=100,o/=100,t.includes("rad")?e=Math.round(e*(180/Math.PI)):t.includes("turn")&&(e=Math.round(e*360)),e>=360&&(e%=360);const s=(1-Math.abs(2*o-1))*n,r=s*(1-Math.abs(e/60%2-1)),f=o-s/2;let l=0,c=0,i=0;return e>=0&&e<60?(l=s,c=r,i=0):e>=60&&e<120?(l=r,c=s,i=0):e>=120&&e<180?(l=0,c=s,i=r):e>=180&&e<240?(l=0,c=r,i=s):e>=240&&e<300?(l=r,c=0,i=s):e>=300&&e<360&&(l=s,c=0,i=r),l=Math.round((l+f)*255),c=Math.round((c+f)*255),i=Math.round((i+f)*255),[l,c,i]},lab:v},P={rgb:t=>C(t),hsl:t=>C(T.hsl(B(t))),lab:t=>t};function k(t){return t.slice(0,3).includes("rgb")?"rgb":t.slice(0,3).includes("hsl")?"hsl":t.slice(0,3).includes("#")?"hex":t.slice(0,3).includes("lab")?"lab":"rgb"}function A(t){const e=k(t),n=T[e](t);return m(n,"rgb")}function m(t,e){return P[e](t)}function y(t){return H(t)&&t.length===3}const D=new Map;function z(t,e,n){if(S(t))t=A(t);else if(y(t))t=m(t,n||"rgb");else throw new Error(`${t} type could not be infered if is string, otherwise type has not been provided as an option if passing a tuple`);if(S(e))e=A(e);else if(y(e))e=m(e,n||"rgb");else throw new Error(`${e} type could not be infered if is string, otherwise type has not been provided as an option `);const o=D.get(JSON.stringify([t,e]));if(o)return o;if(!y(t)||!y(e))throw new Error(`colors: ${t} and ${e} could type could not be infered or converted`);const s=t,r=e,f=s[0]-r[0],l=s[1]-r[1],c=s[2]-r[2],i=Math.sqrt(s[1]*s[1]+s[2]*s[2]),a=Math.sqrt(r[1]*r[1]+r[2]*r[2]),g=i-a;let u=l*l+c*c-g*g;u=u<0?0:Math.sqrt(u);const p=1+.045*i,h=1+.015*i,d=f/1,x=g/p,w=u/h,$=d*d+x*x+w*w,b=$<0?0:Math.sqrt($);return D.set(JSON.stringify([t,e]),b),b}const I=(t,e,n)=>{const{width:o,height:s,channels:r}=e,f=Math.floor(s*n),l=Math.floor(o*n),c={...e,width:l,height:f},i=new Uint8ClampedArray(l*f*r),a=n>=1?1:(1/n)**2;for(let g=0;g<f;g++)for(let u=0;u<l;u++){const p=Array(r).fill(0);for(let h=0;h<1/n;h++)for(let d=0;d<1/n;d++){const x=Math.floor(g*1/n)+h,w=Math.floor(u*1/n)+d,$=r*(x*o+w);for(let b=0;b<r;b++)p[b]+=t[$+b]/a}for(let h=0;h<e.channels;h++){const d=r*(g*l+u)+h;i[d]=p[h]}}return{data:i,info:c}},q=(t,e,n,o)=>{const s=n.length**.5,{width:r,height:f,channels:l}=e;for(let c=0;c<f;c++)for(let i=0;i<r;i++){const a=l*(c*r+i),g=c%s*s+i%s,u=o*n[g];for(let p=0;p<3;p++){const h=t[a+p]+u;t[a+p]=h<=255?h>=0?h:0:255}}},E=(t,e,n,o)=>{const{width:s,height:r,channels:f}=e,l=n.length;for(let c=0;c<r;c++)for(let i=0;i<s;i++){const a=f*(c*s+i);let g=1/0,u=0;for(let p=0;p<l;p++){const h=n[p],d=o?z([t[a],t[a+1],t[a+2]],h,"rgb"):Math.abs(t[a]-h[0])+Math.abs(t[a+1]-h[1])+Math.abs(t[a+2]-h[2]);d<g&&(g=d,u=p)}t[a]=n[u][0],t[a+1]=n[u][1],t[a+2]=n[u][2]}},L=t=>{if(t===0)return[0,2,3,1];const e=L(t-1),n=e.length**.5,o=4**(t+1),s=o**.5;return Array.from({length:o},(r,f)=>{const l=f%s,c=Math.floor(f/s),i=l<s/2,a=c<s/2,g=i?a?0:3:a?2:1;return e[c%n*n+l%n]*4+g})},_=t=>L(t).map(e=>e/4**(t+1)-.5),J=(t,e,n)=>{const{pixelSize:o,palette:s,toDither:r,bayerLevel:f,noiseLevel:l,labComparison:c,rescaleBack:i}=n;return o>1&&({data:t,info:e}=I(t,e,1/o)),r&&q(t,e,_(f),l),E(t,e,s.colors,c),o>1&&i&&({data:t,info:e}=I(t,e,o)),new ImageData(t,e.width,e.height)};onmessage=({data:t})=>{const e=Date.now(),n=J(t.data,t.info,t.config);postMessage({imageData:n,tookMS:Date.now()-e})}})();
